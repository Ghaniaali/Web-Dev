<div class="roles-page">
  <div class="page-header">
    <div class="header-content">
      <h1>Roles Management</h1>
      <p>Manage user roles and permissions for your library system</p>
    </div>
    <button class="btn btn-primary add-role-btn" (click)="toggleAddRoleForm()">
      <span class="btn-icon">{{ showAddRoleForm ? '‚úï' : '+' }}</span>
      {{ showAddRoleForm ? 'Cancel' : 'Add New Role' }}
    </button>
  </div>

  <div class="add-role-section" *ngIf="showAddRoleForm">
    <div class="form-card">
      <div class="form-header">
        <h3>Create New Role</h3>
        <p>Define a new role with specific permissions</p>
      </div>
      
      <form (ngSubmit)="addRole()" #roleForm="ngForm" class="role-form">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="roleName">Role Name*</label>
              <input 
                type="text" 
                id="roleName" 
                name="roleName"
                class="form-input" 
                placeholder="e.g., Librarian Assistant" 
                [(ngModel)]="newRole.name" 
                required
                #roleName="ngModel"
                (input)="checkRoleNameExists()">
              <div class="input-error" *ngIf="roleName.invalid && roleName.touched">
                Role name is required
              </div>
              <div class="input-error" *ngIf="roleNameExists">
                Role name already exists
              </div>
            </div>

            <div class="form-group">
              <label for="roleDescription">Description*</label>
              <textarea 
                id="roleDescription" 
                name="roleDescription"
                class="form-input" 
                placeholder="Describe what this role can do..." 
                [(ngModel)]="newRole.description" 
                rows="3"
                required
                #roleDescription="ngModel">
              </textarea>
              <div class="input-error" *ngIf="roleDescription.invalid && roleDescription.touched">
                Description is required
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Permissions</h4>
          <p class="section-desc">Select the permissions this role should have</p>
          
          <div class="permissions-container">
            <div *ngFor="let category of getPermissionCategories()" class="permission-category">
              <div class="category-header">
                <h5>{{ category }}</h5>
                <span class="category-count">
                  {{ getSelectedPermissionsInCategory(category) }}/{{ getPermissionsByCategory()[category].length }} selected
                </span>
              </div>
              
              <div class="permissions-list">
                <div *ngFor="let permission of getPermissionsByCategory()[category]" class="permission-item">
                  <label class="permission-label">
                    <input 
                      type="checkbox" 
                      [value]="permission.id"
                      [checked]="newRole.permissions.includes(permission.id)"
                      (change)="onPermissionChange(permission.id, $event)"
                      class="permission-checkbox">
                    <div class="permission-content">
                      <span class="permission-name">{{ permission.name }}</span>
                      <span class="permission-desc">{{ permission.description }}</span>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancelAddRole()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="roleForm.invalid || roleNameExists">
            <span class="btn-icon">‚úì</span>
            Create Role
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="roles-section">
    <div class="section-header">
      <h3>Existing Roles</h3>
      <span class="roles-count">{{ roles.length }} role{{ roles.length !== 1 ? 's' : '' }} configured</span>
    </div>

    <div class="roles-grid">
      <div *ngFor="let role of roles" class="role-card" [class.system-role]="role.isDefault">
        <div class="role-card-header">
          <div class="role-title">
            <h4>{{ role.name }}</h4>
            <div class="role-badges">
              <span class="role-type-badge" [class.system]="role.isDefault" [class.custom]="!role.isDefault">
                {{ role.isDefault ? 'System Role' : 'Custom Role' }}
              </span>
            </div>
          </div>
          <div class="role-actions" *ngIf="!role.isDefault">
            <button class="action-btn edit-btn" (click)="editRole(role)" title="Edit Role">
              <span>‚úèÔ∏è</span>
            </button>
            <button class="action-btn delete-btn" (click)="deleteRole(role.id)" title="Delete Role">
              <span>üóëÔ∏è</span>
            </button>
          </div>
        </div>

        <p class="role-description">{{ role.description }}</p>

        <div class="role-stats">
          <div class="stat-item">
            <span class="stat-label">Permissions:</span>
            <span class="stat-value">{{ role.permissions.length }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Users:</span>
            <span class="stat-value">{{ getUserCountByRole(role.id) }}</span>
          </div>
        </div>

        <div class="permissions-preview">
          <h5>Key Permissions</h5>
          <div class="permissions-tags">
            <span *ngFor="let permissionId of role.permissions.slice(0, 4)" class="permission-tag">
              {{ getPermissionName(permissionId) }}
            </span>
            <span *ngIf="role.permissions.length > 4" class="more-permissions">
              +{{ role.permissions.length - 4 }} more
            </span>
          </div>
        </div>

        <div class="role-card-footer">
          <span class="creation-date">
            Created {{ role.createdAt | date:'MMM d, y' }}
          </span>
          <button class="btn btn-outline view-details-btn" (click)="viewRoleDetails(role)">
            View Details
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit Role</h3>
        <button class="modal-close-btn" (click)="closeEditModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="updateRole()" #editForm="ngForm">
          <div class="form-group">
            <label for="editRoleName">Role Name</label>
            <input 
              type="text" 
              id="editRoleName" 
              name="editRoleName"
              class="form-input" 
              [(ngModel)]="editingRole!.name" 
              required>
          </div>

          <div class="form-group">
            <label for="editRoleDescription">Description</label>
            <textarea 
              id="editRoleDescription" 
              name="editRoleDescription"
              class="form-input" 
              [(ngModel)]="editingRole!.description" 
              rows="3"
              required>
            </textarea>
          </div>

          <div class="form-group">
            <label>Permissions</label>
            <div class="permissions-container">
              <div *ngFor="let category of getPermissionCategories()" class="permission-category">
                <div class="category-header">
                  <h5>{{ category }}</h5>
                </div>
                <div class="permissions-list">
                  <div *ngFor="let permission of getPermissionsByCategory()[category]" class="permission-item">
                    <label class="permission-label">
                      <input 
                        type="checkbox" 
                        [value]="permission.id"
                        [checked]="editingRole!.permissions.includes(permission.id)"
                        (change)="onEditPermissionChange(permission.id, $event)"
                        class="permission-checkbox">
                      <div class="permission-content">
                        <span class="permission-name">{{ permission.name }}</span>
                        <span class="permission-desc">{{ permission.description }}</span>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">
              <span class="btn-icon">‚úì</span>
              Update Role
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
